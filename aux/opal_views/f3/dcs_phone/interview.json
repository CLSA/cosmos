{"from": ["clsa-dcs-f3.Participants","cosmos_dcs.QC_F3_meta"],"name": "QC_F3_interview","datasourceName": "cosmos_dcs_phone","where": "$('clsa-dcs-f3.Participants:DCS_PHONE')","Magma.VariableListViewDto.view": {"variables": [{"name": "barcode","entityType": "Participant","valueType": "text","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "$('Admin.Participant.barcode')"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "start_date","entityType": "Participant","valueType": "text","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "$('Admin.Interview.startDate').format('yyyy-MM-dd')"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "site","entityType": "Participant","valueType": "text","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "$('Admin.ApplicationConfiguration.siteName').lowerCase().map({\n  'britishcolumbia':'University of BC DCS',\n  'british columbia':'University of BC DCS',\n  'calgary':'Calgary DCS',\n  'dalhousie':'Dalhousie DCS',\n  'hamilton':'Hamilton DCS',\n  'hamiltonhome1':'Hamilton DCS',\n  'himilton':'Hamilton DCS',\n  'manitoba':'Manitoba DCS',\n  'mcgill':'McGill DCS',\n  'mcmaster':'Hamilton DCS',\n  'memorial':'Memorial DCS',\n  'memorial university':'Memorial DCS',\n  'ottawa':'Ottawa DCS',\n  'sherbrooke':'Sherbrooke DCS',\n  'simon fraser':'Simon Fraser DCS',\n  'simonfraser':'Simon Fraser DCS',\n  'universityofbc':'University of BC DCS',\n  'university of manitoba':'Manitoba DCS',\n  'university of victoria':'Victoria DCS',\n  'victoria':'Victoria DCS'},null)"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "duration","entityType": "Participant","valueType": "integer","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "var t = $('clsa-dcs-f3.Participants:Admin.Action.dateTime').asSequence().trimmer()\nvar d = []\nfor(var i=0;i<t.size();i++) {\n  var dy = t.valueAt(i).format('yyyyMMdd')\n  if(undefined===d[dy]){\n    d[dy]=[t.valueAt(i)]\n  } else {\n    d[dy].push(t.valueAt(i))\n  }\n}\nvar res = newValue(0,'integer')\nfor(var dy in d) {\n  if(1<d[dy].length) {\n    var l = newSequence(d[dy],'datetime').sort()\n    res = res.plus(l.last().time().minus(l.first().time()).div(1000).whenNull(0))\n  }    \n}\nres.gt(0).value()?res:null"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "stage_duration","entityType": "Participant","valueType": "integer","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "var group_stages=['ConclusionPhone','ContraIndications','DiseaseSymptoms','GenHealth','HeightWeight','OS','ProxyConChoices','SocialNetwork']\nvar stages = $('clsa-dcs-f2.Participants:Admin.StageInstance.stage').asSequence().filter(function(v,i) {\n    return i==this.indexOf(v) && -1!=group_stages.indexOf(v.value())\n  })\nvar res = newValue(0,'integer')\nfor(var i = 0; i < stages.size(); i++) {\n  var stage = stages.valueAt(i).value()\n  var pre = newValue(null, 'datetime')\n  var post = newValue(null, 'datetime')\n\n  if(-1 != $('cosmos_dcs.QC_F2_meta:group_questionnaire').indexOf(stage)) {\n    pre = $('clsa-dcs-f2.'+stage+':QuestionnaireRun.timeStart')\n    post = $('clsa-dcs-f2.'+stage+':QuestionnaireRun.timeEnd')\n  } else if(-1 != $('cosmos_dcs.QC_F2_meta:group_other').indexOf(stage)) {\n    pre = $('clsa-dcs-f2.'+stage+':timeStart')\n    post = $('clsa-dcs-f2.'+stage+':timeEnd')\n  }\n  \n  res = res.plus(\n      post.time().minus(pre.time()).div(1000).whenNull(\n        $group('clsa-dcs.Participants:Admin.StageInstance.stage',stage,\n        'Admin.StageInstance.duration').asSequence().sum().whenNull(0)\n      )\n    )  \n  /*\n  var t = post.time().minus(pre.time()).div(1000).whenNull(0)\n  if(t.gt(0).value()) {\n    res = res.plus(t)\n  } else {    \n    t = $group('clsa-dcs-f2.Participants:Admin.StageInstance.stage',\n        stage,\n        'Admin.StageInstance.duration').asSequence().filter(function(v) {\n        return v.gt(0)\n      }).sum().div(1000).whenNull(0)\n    res = res.plus(t)\n  }\n  */\n}\n\nres.gt(0).value()?res:null"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "type","entityType": "Participant","valueType": "text","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "var res = 'dcs'\n//if($('clsa-dcs-f3.Participants:DCSatHOME').whenNull(false).value()) {\n//  res = 'dcs home'\n//} \n//else \nif($('clsa-dcs-f3.Participants:DCS_PHONE').whenNull(false).value()) {\n  res = 'dcs phone'\n}\nres"}],"unit": "","index": 0,"referencedEntityType": ""}]}}