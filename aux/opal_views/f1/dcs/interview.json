{"from": ["clsa-dcs-f1.Participants","cosmos_dcs.QC_F1_meta"],"name": "QC_F1_interview","datasourceName": "cosmos_dcs","where": "$('clsa-dcs-f1.Participants:DCSatHOME').not().whenNull(true).and($('clsa-dcs-f1.Participants:DCS_PHONE').not().whenNull(true))","Magma.VariableListViewDto.view": {"variables": [{"name": "barcode","entityType": "Participant","valueType": "text","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "$('Admin.Participant.barcode')"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "start_date","entityType": "Participant","valueType": "date","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "$('Admin.Interview.startDate')"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "site","entityType": "Participant","valueType": "text","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "$('Admin.ApplicationConfiguration.siteName').lowerCase().map({\n  'britishcolumbia':'University of BC DCS',\n  'british columbia':'University of BC DCS',\n  'calgary':'Calgary DCS',\n  'dalhousie':'Dalhousie DCS',\n  'hamilton':'Hamilton DCS',\n  'hamiltonhome1':'Hamilton DCS',\n  'himilton':'Hamilton DCS',\n  'manitoba':'Manitoba DCS',\n  'mcgill':'McGill DCS',\n  'mcmaster':'Hamilton DCS',\n  'memorial':'Memorial DCS',\n  'memorial university':'Memorial DCS',\n  'ottawa':'Ottawa DCS',\n  'sherbrooke':'Sherbrooke DCS',\n  'simon fraser':'Simon Fraser DCS',\n  'simonfraser':'Simon Fraser DCS',\n  'universityofbc':'University of BC DCS',\n  'university of manitoba':'Manitoba DCS',\n  'university of victoria':'Victoria DCS',\n  'victoria':'Victoria DCS'},null)"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "duration","entityType": "Participant","valueType": "integer","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "var res = null\nvar te = $('clsa-dcs-f1.Participants:Admin.Participant.captureEndDate').time()\nvar tb = $('clsa-dcs-f1.Participants:Admin.Participant.captureStartDate').time()\nif(te.isNull().not().and(tb.isNull().not()).value()) {\n res = te.minus(tb).div(1000)\n if(res.eq(0).value()) res = null\n}\nres"}],"unit": "","index": 0,"referencedEntityType": ""},{"name": "stage_duration","entityType": "Participant","valueType": "integer","mimeType": "","isRepeatable": false,"attributes": [{"name": "script","value": "var res = null\nvar stages = $('clsa-dcs-f1.Participants:Admin.StageInstance.stage').asSequence()\nvar unique = stages.filter(function(v,i) {\n    return i==this.indexOf(v)\n  })\nvar t = newValue(0,'integer')\nvar group_stages=['ECG','ForearmBoneDensity','DualHipBoneDensity','WholeBodyBoneDensity','LateralBoneDensity','SpineBoneDensity']\nfor(var i = 0; i < unique.size(); i++) {\n  var stage = unique.valueAt(i).value()\n  var v = null\n  if(-1 != group_stages.indexOf(stage)) {\n    if('ECG' == stage) {\n      v = $('cosmos_dcs.QC_F1_meta:group_duration_ecg').asSequence()\n    } else {\n      v = $('cosmos_dcs.QC_F1_meta:group_duration_dexa').asSequence()\n    }\n  } else if('Consent' == stage) {\n    var begin = $('clsa-dcs-f1.Consent:timeStart')\n    var end = $('clsa-dcs-f1.Consent:timeEnd')\n    if(begin.isNull().or(end.isNull()).value()) continue;\n    v = end.time().minus(begin.time()).div(1000).asSequence()\n  } else {\n    v = $group(\n      'clsa-dcs-f1.Participants:Admin.StageInstance.stage',\n      stage,\n      'Admin.StageInstance.duration').asSequence()\n  }    \n  if(null == v) continue\n  \n  t = t.plus(v.sum())\n}\n\nif(t.gt(0).value()) {\n  res = t\n}\nres"}],"unit": "","index": 0,"referencedEntityType": ""}]}}